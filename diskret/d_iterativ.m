% Välj först godtycklig polplacering (q_k)
% - För given polplacering presenterar funktionen regulatorparametrarna (Kr,c1,c2,c3,d0,d1,d2).
% - Simulerar det återkopplade systemet för N = 70 samplingar, returnerar i vektorer
%   utloppstemperaturen (y), styreffekten (u) och tiden (t).

function [y u t] = d_iterativ(q_k)
a1 = -1.6860;
a2 = 0.7097;
b3 = 1.5260e-06;
b4 = 1.3610e-06;
q  = q_k
Kr = -(2361183241434822606848*q^3)/6816736018022333 + (7083549724304467820544*q^2)/6816736018022333 - (7083549724304467820544*q)/6816736018022333 + 2361183241434822606848/6816736018022333
c1 = 1343/500 - 3*q
c2 = 3*q^2 - (4029*q)/500 + 301181/62500
c3 = -(1327466112874474796439510129852430213846220285015000*q^3)/10651332194076104339061685961065158384970219288791281 + (24947146271000164144303648447911839060843430931753479*q^2)/10651332194076104339061685961065158384970219288791281 - (27149224677262573319874147130223483924911780487994583797*q)/5325666097038052169530842980532579192485109644395640500 + 926104841101463488780781550149655958071494426115943031429/332854131064878260595677686283286199530319352774727531250
d0 = -(6110003985060045229383251247700656165922412773939236306944*q^3)/10651332194076104339061685961065158384970219288791281 + (4986999389651464712285845635370638712731929466996305474617344*q^2)/1331416524259513042382710745133144798121277411098910125 - (1020688656614397694732976264088216396073921457878295233217691648*q)/166427065532439130297838843141643099765159676387363765625 + 60475544797479590835593638557318167370326651002239648169168207872/20803383191554891287229855392705387470644959548420470703125
d1 = (3112805664800708920027824490335592561049122132143974121472*q^3)/10651332194076104339061685961065158384970219288791281 - (26147855538443263296679856319499022069032954426628573195403264*q^2)/6657082621297565211913553725665723990606387055494550625 + (6450783282633810139992634599826566114833567059036747201813413888*q)/832135327662195651489194215708215498825798381936818828125 - 417261381520136873746486073947567131931471321624608779333881823232/104016915957774456436149276963526937353224797742102353515625
d2 = -(692213593171943264470864977050316873216081921657656049664*q^3)/10651332194076104339061685961065158384970219288791281 + (8130505927869588936174925144674666901790880648121267513196544*q^2)/6657082621297565211913553725665723990606387055494550625 - (2212045916772277816443290404639088934016156464204548747084955648*q)/832135327662195651489194215708215498825798381936818828125 + 150913070749841259156665261379876495061179595553380443128040783872/104016915957774456436149276963526937353224797742102353515625

% ITERATIV BERÄKNING
%
% A(z) = 1 + a1*z^-1 + a2*z^-2
% B(z) = b3*z^-3 + b4*z^-4
% C(z) = 1 + (c1-1)*z^-1 + (c2-c1)*z^-2 + (c3-c2)*z^-3 + (-c3)*z^-4
% D(z) = d0 + d1*z^-1 + d2*z^-2
%
%               B(z)
% Y(z) = U(z) * ----
%               A(z)
%
%        Kr*R(z)-D(z)*Y(z)
% U(z) = -----------------
%             C(z)
%

N = 70;
r = 1; % Simulera enhetssteg
clear y u;
t = 1:N;

k = 1;
y(k) = 0;
u(k) = Kr*r - d0*y(k);
k = 2;
y(k) = -a1*y(k-1);
u(k) = Kr*r - (c1-1)*u(k-1) - d0*y(k) - d1*y(k-1);
k = 3;
y(k) = -a1*y(k-1) - a2*y(k-2);
u(k) = Kr*r - (c1-1)*u(k-1) - (c2-c1)*u(k-2) - d0*y(k) - d1*y(k-1) - d2*y(k-2);
k = 4;
y(k) = -a1*y(k-1) - a2*y(k-2) + b3*u(k-3);
u(k) = Kr*r - (c1-1)*u(k-1) - (c2-c1)*u(k-2) - (c3-c2)*u(k-3) - d0*y(k) - d1*y(k-1) - d2*y(k-2);
 
for k=5:N
    y(k) = -a1*y(k-1) - a2*y(k-2) + b3*u(k-3) + b4*u(k-4); % MÄT via AD-omvandlare
    u(k) = Kr*r - (c1-1)*u(k-1) - (c2-c1)*u(k-2) - (c3-c2)*u(k-3) - (-c3)*u(k-4) - d0*y(k) - d1*y(k-1) - d2*y(k-2); % STYR via DA-omvandlare
end

%
% SLUT
end